import{_ as Y,r as m,g as Z,o as ee,i as u,b as g,c as M,d as t,k as s,j as o,y as c,h as N,e as z,z as A,E as f,A as h,F as ae,x as se,B as te,v as _,C as le,D as E,G as L,H as oe,I as ne}from"./index-ce297468.js";const re={class:"messages-container"},ie={class:"messages-header"},de={class:"messages-title"},ue={class:"messages-filter"},ce={class:"filter-item"},_e={class:"filter-item"},pe={class:"filter-item"},ve={class:"message-content-wrapper"},me={class:"message-list-container"},ge=["onClick"],fe={class:"message-item-header"},ye={class:"message-type"},he={class:"message-time"},be={class:"message-item-content"},ke={class:"message-title"},Ce={class:"message-body"},Me={class:"message-item-footer"},ze={key:1,class:"loading-state"},we={key:0,class:"message-detail-container"},Ve={class:"detail-header"},xe={class:"detail-title"},De={class:"detail-meta"},Se={class:"meta-item"},Ae={class:"meta-item"},Pe={class:"meta-item"},Ue={class:"detail-content"},Ne={class:"detail-actions"},$e={class:"messages-pagination"},Be={__name:"Messages",setup(Re){const w=m(!1),b=m(""),k=m(""),C=m(""),V=m([]),y=m(0),d=m({currentPage:1,pageSize:20,total:0}),P=m(null),n=m(null),$=Z(()=>V.value.filter(a=>{const e=!b.value||a.title.includes(b.value)||a.content.includes(b.value),r=!k.value||a.message_type===k.value,v=!C.value||C.value==="unread"&&!a.is_read||C.value==="read"&&a.is_read;return e&&r&&v})),B=a=>({新任务通知:"warning",提交确认通知:"success",统计通知:"info",队列变更通知:"danger",轮询提醒:"primary"})[a]||"default",j=a=>{if(!a)return"";const e=new Date(a),v=new Date-e,p=Math.floor(v/(1e3*60)),D=Math.floor(v/(1e3*60*60)),i=Math.floor(v/(1e3*60*60*24));return p<1?"刚刚":p<60?`${p}分钟前`:D<24?`${D}小时前`:i<7?`${i}天前`:e.toLocaleDateString("zh-CN")},F=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",x=async()=>{w.value=!0;try{const a=await A.getMessages({page:d.value.currentPage,limit:d.value.pageSize,messageType:k.value||void 0});a.success?(V.value=a.data.messages,d.value.total=a.data.pagination.total,H()):f.error("获取消息列表失败")}catch(a){console.error("获取消息列表错误:",a),f.error("获取消息列表失败，请稍后重试")}finally{w.value=!1}},H=async()=>{try{const a=await A.getUnreadCount();a.success&&(y.value=a.data.unreadCount)}catch(a){console.error("获取未读消息数量错误:",a)}},I=a=>{P.value=a.id,n.value=a,a.is_read||U(a.id)},R=()=>{P.value=null,n.value=null},U=async a=>{try{if((await A.markAsRead(a)).success){const r=V.value.find(v=>v.id===a);r&&(r.is_read=!0,y.value--),n.value&&n.value.id===a&&(n.value.is_read=!0),f.success("消息已标记为已读")}else f.error("标记已读失败")}catch(e){console.error("标记消息已读错误:",e),f.error("标记已读失败，请稍后重试")}},G=async()=>{try{(await A.markAllAsRead()).success?(V.value.forEach(e=>{e.is_read=!0}),y.value=0,f.success("所有消息已标记为已读")):f.error("标记全部已读失败")}catch(a){console.error("标记所有消息已读错误:",a),f.error("标记全部已读失败，请稍后重试")}},K=a=>{d.value.pageSize=a,d.value.currentPage=1,x()},q=a=>{d.value.currentPage=a,x()};return ee(()=>{x()}),(a,e)=>{const r=u("el-icon"),v=u("el-badge"),p=u("el-button"),D=u("el-input"),i=u("el-option"),T=u("el-select"),S=u("el-tag"),J=u("el-empty"),O=u("el-skeleton"),Q=u("el-pagination"),W=u("el-card");return g(),M("div",re,[t("div",ie,[t("h2",de,[s(r,null,{default:o(()=>[s(h(E))]),_:1}),e[6]||(e[6]=c(" 我的消息 ",-1)),y.value>0?(g(),N(v,{key:0,value:y.value,type:"danger",class:"unread-badge"},null,8,["value"])):z("",!0)]),s(p,{type:"primary",size:"large",onClick:G,disabled:y.value===0,class:"mark-all-btn"},{default:o(()=>[s(r,null,{default:o(()=>[s(h(L))]),_:1}),e[7]||(e[7]=c(" 全部标为已读 ",-1))]),_:1},8,["disabled"])]),s(W,{shadow:"hover",class:"messages-card"},{default:o(()=>[t("div",ue,[t("div",ce,[s(D,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=l=>b.value=l),placeholder:"搜索消息标题或内容","prefix-icon":"el-icon-search",clearable:"",size:"large",class:"search-input"},null,8,["modelValue"])]),t("div",_e,[s(T,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=l=>k.value=l),placeholder:"消息类型",size:"large",clearable:"",class:"type-select"},{default:o(()=>[s(i,{label:"全部类型",value:""}),s(i,{label:"新任务通知",value:"新任务通知"}),s(i,{label:"提交确认通知",value:"提交确认通知"}),s(i,{label:"统计通知",value:"统计通知"}),s(i,{label:"队列变更通知",value:"队列变更通知"}),s(i,{label:"轮询提醒",value:"轮询提醒"})]),_:1},8,["modelValue"])]),t("div",pe,[s(T,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=l=>C.value=l),placeholder:"消息状态",size:"large",clearable:"",class:"status-select"},{default:o(()=>[s(i,{label:"全部状态",value:""}),s(i,{label:"未读消息",value:"unread"}),s(i,{label:"已读消息",value:"read"})]),_:1},8,["modelValue"])])]),t("div",ve,[t("div",me,[(g(!0),M(ae,null,se($.value,l=>(g(),M("div",{key:l.id,class:te(["message-item",{"unread-message":!l.is_read,"active-message":P.value===l.id}]),onClick:X=>I(l)},[t("div",fe,[t("div",ye,[s(S,{type:B(l.message_type),class:"message-type-tag"},{default:o(()=>[c(_(l.message_type),1)]),_:2},1032,["type"]),l.is_read?z("",!0):(g(),N(S,{key:0,type:"danger",size:"small",class:"unread-tag"},{default:o(()=>[...e[8]||(e[8]=[c("未读",-1)])]),_:1}))]),t("div",he,_(j(l.created_at)),1)]),t("div",be,[t("h3",ke,_(l.title),1),t("p",Ce,_(l.content),1)]),t("div",Me,[s(p,{type:"text",size:"small",onClick:le(X=>U(l.id),["stop"]),disabled:l.is_read,class:"mark-read-btn"},{default:o(()=>[c(_(l.is_read?"已读":"标为已读"),1)]),_:2},1032,["onClick","disabled"])])],10,ge))),128)),!w.value&&$.value.length===0?(g(),N(J,{key:0,description:"暂无消息",class:"empty-state"},{image:o(()=>[s(r,{class:"empty-icon"},{default:o(()=>[s(h(E))]),_:1})]),default:o(()=>[s(p,{type:"primary",onClick:x},{default:o(()=>[...e[9]||(e[9]=[c("刷新消息",-1)])]),_:1})]),_:1})):z("",!0),w.value?(g(),M("div",ze,[s(O,{rows:5,animated:""})])):z("",!0)]),n.value?(g(),M("div",we,[t("div",Ve,[t("h3",xe,_(n.value.title),1),s(p,{type:"primary",size:"small",onClick:R},{default:o(()=>[s(r,null,{default:o(()=>[s(h(oe))]),_:1}),e[10]||(e[10]=c(" 关闭 ",-1))]),_:1})]),t("div",De,[t("div",Se,[e[11]||(e[11]=t("span",{class:"meta-label"},"消息类型：",-1)),s(S,{type:B(n.value.message_type)},{default:o(()=>[c(_(n.value.message_type),1)]),_:1},8,["type"])]),t("div",Ae,[e[12]||(e[12]=t("span",{class:"meta-label"},"状态：",-1)),s(S,{type:n.value.is_read?"success":"danger"},{default:o(()=>[c(_(n.value.is_read?"已读":"未读"),1)]),_:1},8,["type"])]),t("div",Pe,[e[13]||(e[13]=t("span",{class:"meta-label"},"时间：",-1)),t("span",null,_(F(n.value.created_at)),1)])]),t("div",Ue,[e[14]||(e[14]=t("h4",null,"消息内容：",-1)),t("p",null,_(n.value.content),1)]),t("div",Ne,[s(p,{type:"primary",onClick:e[3]||(e[3]=l=>U(n.value.id)),disabled:n.value.is_read},{default:o(()=>[s(r,null,{default:o(()=>[s(h(L))]),_:1}),c(" "+_(n.value.is_read?"已读":"标为已读"),1)]),_:1},8,["disabled"]),s(p,{onClick:R},{default:o(()=>[s(r,null,{default:o(()=>[s(h(ne))]),_:1}),e[15]||(e[15]=c(" 返回列表 ",-1))]),_:1})])])):z("",!0)]),t("div",$e,[s(Q,{"current-page":d.value.currentPage,"onUpdate:currentPage":e[4]||(e[4]=l=>d.value.currentPage=l),"page-size":d.value.pageSize,"onUpdate:pageSize":e[5]||(e[5]=l=>d.value.pageSize=l),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:d.value.total,onSizeChange:K,onCurrentChange:q,background:"",class:"pagination"},null,8,["current-page","page-size","total"])])]),_:1})])}}},Ee=Y(Be,[["__scopeId","data-v-a060ab52"]]);export{Ee as default};
