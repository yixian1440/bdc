# 统计报表重构计划

## 问题分析

1. **收件类型占比无数据**：前端数据映射逻辑问题
2. **案件类型详细统计分析**：数据处理和显示问题
3. **角色维度问题**：收件人角色看到了管理员应该看到的内容，需要按角色区分统计内容

## 重构方案

### 1. 添加角色权限控制

**修改Statistics.vue**：

* 从Vuex store获取当前用户角色

* 根据角色动态显示不同的统计内容

* 为不同角色设计不同的统计维度

**修改内容**：

```vue
<template>
  <!-- 管理员视图 -->
  <div v-if="userRole === '管理员'" class="admin-statistics">
    <!-- 管理员看到的完整统计内容 -->
  </div>
  
  <!-- 收件人视图 -->
  <div v-else-if="userRole === '收件人'" class="receiver-statistics">
    <!-- 收件人看到的统计内容（只显示自己的数据） -->
  </div>
  
  <!-- 开发商视图 -->
  <div v-else-if="userRole === '开发商'" class="developer-statistics">
    <!-- 开发商看到的统计内容 -->
  </div>
  
  <!-- 国资企业专窗视图 -->
  <div v-else-if="userRole === '国资企业专窗'" class="state-owned-enterprise-statistics">
    <!-- 国资企业专窗看到的统计内容 -->
  </div>
</template>

<script>
// 获取用户角色
const userRole = computed(() => store.getters.userRole);
</script>
```

### 2. 修复数据映射逻辑

**修改useStatistics.js**：

* 确保前端能正确处理后端返回的数据格式

* 修复收件类型占比无数据的问题

**修改内容**：

```javascript
// 修复typeData和receiverData的数据映射
const statisticsData = {
  // ...
  typeData: Array.isArray(backendData.typeStats) ? backendData.typeStats.map(typeStat => ({
    name: typeStat.case_type || typeStat.type_name || typeStat.name || '未知类型',
    value: typeStat.total_count || 0,
    // 确保percentage正确计算
    percentage: totalCount > 0 ? Math.round(((typeStat.total_count || 0) / totalCount) * 100) : 0
  })) : [],
  // ...
};
```

### 3. 重构统计维度

**为不同角色设计不同的统计维度**：

* **管理员**：看到所有数据，包括案件类型、收件人、开发商等维度

* **收件人**：只看到自己的数据，包括自己的案件类型、处理进度等维度

* **开发商**：看到自己的业务数据，包括案件类型、处理进度等维度

* **国资企业专窗**：看到自己的数据，包括案件类型、处理进度等维度

**修改Statistics.vue**：

```vue
<!-- 收件人视图 -->
<div v-else-if="userRole === '收件人'" class="receiver-statistics">
  <h3>我的统计数据</h3>
  
  <!-- 总览统计卡片 -->
  <el-row :gutter="20" class="overview-section">
    <el-col :span="6">
      <el-card class="overview-card">
        <div class="overview-content">
          <div class="overview-number">{{ statistics.totalCount || 0 }}</div>
          <div class="overview-label">我的总案件数</div>
        </div>
      </el-card>
    </el-col>
    <!-- 其他统计卡片 -->
  </el-row>
  
  <!-- 我的案件类型统计 -->
  <el-card class="chart-card">
    <div slot="header" class="card-header">
      <span>我的案件类型统计</span>
    </div>
    <TypeChart 
      :data="statistics.typeData" 
      :loading="isChartLoading"
      :error="chartErrors.type"
    />
  </el-card>
  
  <!-- 我的案件处理进度统计 -->
  <el-card class="chart-card">
    <div slot="header" class="card-header">
      <span>我的案件处理进度</span>
    </div>
    <!-- 处理进度统计组件 -->
  </el-card>
</div>
```

### 4. 修改后端API

**确保后端根据角色返回不同的数据**：

* 收件人角色只返回自己的数据

* 管理员角色返回所有数据

* 其他角色返回相应的数据

### 5. 添加权限验证

**在API请求中添加角色信息**：

* 确保后端根据角色返回正确的数据

* 防止权限泄露

## 预期效果

1. ✅ **角色维度区分**：不同角色看到不同的统计内容
2. ✅ **收件类型占比**：修复无数据问题，正确显示占比
3. ✅ **案件类型详细统计**：正确显示案件类型统计数据
4. ✅ **数据安全**：确保用户只能看到自己的数据
5. ✅ **用户体验**：为不同角色提供有针对性的统计信息

## 技术实现

* **前端**：Vue 3 + Element Plus + Vuex

* **后端**：Node.js + Express + MySQL

* **数据处理**：根据角色动态调整数据格式和内容

* **权限控制**：前端角色判断 + 后端权限验证

## 重构范围

1. **Statistics.vue**：主统计页面，添加角色控制逻辑
2. **useStatistics.js**：统计数据处理，添加角色数据映射
3. **TypeChart.vue**：案件类型统计组件
4. **ReceiverChart.vue**：收件人统计组件
5. **后端API**：根据角色返回不同的数据

## 实现步骤

1. 修改Statistics.vue，添加角色获取和动态渲染逻辑
2. 修改useStatistics.js，添加角色参数和数据处理逻辑
3. 修复数据映射问题，确保收件类型占比正确显示
4. 为不同角色设计不同的统计维度
5. 测试不同角色的统计内容显示
6. 确保数据安全和权限控制

## 预期完成时间

* 前端修改：1小时

* 后端修改：30分钟

* 测试验证：30分钟

## 风险评估

* **数据一致性**：确保不同角色的数据显示正确

* **权限安全**：防止权限泄露

* **用户体验**：确保不同角色的统计内容有针对性

## 验收标准

1. 不同角色看到不同的统计内容
2. 收件类型占比正确显示
3. 案件类型详细统计正确显示
4. 数据安全，用户只能看到自己的数据
5. 页面加载正常，无错误
6. 用户体验

