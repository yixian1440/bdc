# 系统日志和监控功能实现计划

## 一、数据库表结构设计

### 1. 系统日志表 (system\_logs)

* **表结构**：

  * `id` (INT, PRIMARY KEY, AUTO\_INCREMENT)

  * `user_id` (INT, 关联users表)

  * `username` (VARCHAR(50), 用户名)

  * `action` (VARCHAR(100), 操作类型)

  * `description` (TEXT, 操作描述)

  * `ip_address` (VARCHAR(50), 客户端IP)

  * `user_agent` (TEXT, 用户代理)

  * `level` (VARCHAR(20), 日志级别: info/warning/error)

  * `created_at` (DATETIME, 记录时间)

### 2. 系统监控表 (system\_monitoring)

* **表结构**：

  * `id` (INT, PRIMARY KEY, AUTO\_INCREMENT)

  * `cpu_usage` (DECIMAL(5,2), CPU使用率%)

  * `memory_usage` (DECIMAL(5,2), 内存使用率%)

  * `disk_usage` (DECIMAL(5,2), 磁盘使用率%)

  * `network_in` (BIGINT, 网络入流量字节)

  * `network_out` (BIGINT, 网络出流量字节)

  * `process_count` (INT, 进程数)

  * `active_connections` (INT, 活跃连接数)

  * `created_at` (DATETIME, 记录时间)

## 二、后端服务实现

### 1. 日志服务 (LogService)

* **功能**：

  * 记录登录日志

  * 记录操作日志（新增案件、发送消息等）

  * 记录系统事件日志

  * 提供日志查询API

### 2. 监控服务 (MonitoringService)

* **功能**：

  * 收集服务器CPU、内存、磁盘使用情况

  * 收集网络流量数据

  * 收集进程信息

  * 定期存储监控数据到数据库

  * 提供监控数据查询API

### 3. API接口

* **日志相关**：

  * `GET /api/admin/logs` - 获取系统日志列表（支持分页、筛选）

  * `GET /api/admin/logs/stats` - 获取日志统计数据

  * `GET /api/admin/logs/:id` - 获取日志详情

* **监控相关**：

  * `GET /api/admin/monitoring` - 获取监控数据列表

  * `GET /api/admin/monitoring/stats` - 获取监控统计数据

  * `GET /api/admin/monitoring/latest` - 获取最新监控数据

## 三、前端界面实现

### 1. 日志管理页面

* **功能**：

  * 日志列表展示（支持分页、搜索、筛选）

  * 日志统计图表（操作类型分布、时间趋势）

  * 日志详情查看

  * 导出日志功能

### 2. 系统监控页面

* **功能**：

  * 实时系统状态展示

  * CPU、内存使用趋势图表

  * 磁盘使用情况图表

  * 网络流量监控图表

  * 系统健康状态评估

### 3. 集成到管理员菜单

* 在管理员dashboard中添加"系统日志"和"系统监控"菜单项

## 四、集成实现

### 1. 登录日志集成

* 修改auth.js，在登录成功和失败时记录日志

### 2. 操作日志集成

* 修改cases.js，在新增案件时记录日志

* 修改messages.js，在发送消息时记录日志

* 其他关键操作点的日志记录

### 3. 监控功能集成

* 在server.js中添加监控数据收集定时任务

* 集成系统资源监控库（如os、process等）

### 4. 权限控制

* 确保只有管理员角色可以访问日志和监控功能

* 在API路由中添加权限验证中间件

## 五、技术实现细节

### 1. 数据库操作

* 使用现有的数据库连接池

* 实现表结构自动检测和创建

### 2. 监控数据收集

* 使用Node.js内置的os模块收集系统信息

* 使用process模块收集进程信息

* 使用定时任务定期收集数据

### 3. 前端图表

* 使用现有图表库（如ECharts）展示统计数据

* 实现实时数据更新

### 4. 性能优化

* 日志记录使用异步操作，避免阻塞主流程

* 监控数据收集设置合理的采集间隔

* 实现日志数据的定期清理机制

## 六、实施步骤

1. **创建数据库表**：创建system\_logs和system\_monitoring表
2. **实现后端服务**：开发LogService和MonitoringService
3. **添加API接口**：实现日志和监控相关的API路由
4. **集成日志记录**：修改现有代码，添加日志记录点
5. **实现前端界面**：开发日志管理和系统监控页面
6. **集成到系统**：添加菜单和权限控制
7. **测试验证**：确保所有功能正常工作
8. **部署上线**：将功能部署到生产环境

## 七、预期效果

* 管理员可以查看完整的系统操作日志

* 管理员可以监控服务器的实时运行状态

* 系统运行状态以图表方式直观展示

* 日志和监控数据有完整的历史记录

* 系统异常情况能够及时发现和处理

